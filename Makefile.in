
CC       = @CC@
CPPFLAGS = -Isrc -Ikeys/include @CPPFLAGS@ -fPIC
CFLAGS   = -Wno-unused-result @CFLAGS@ @CPPFLAGS@ @DEFS@ @DEBUG@
LIBS     = @LIBS@
LDFLAGS  = @LDFLAGS@ -Lkeys -lc4gh-keys -Lkeys/openssh -lopenssh -Lkeys/openbsd-compat -lopenbsd-compat

EXTRA_LIBS = keys/libc4gh-keys.a keys/openssh/libopenssh.a keys/openbsd-compat/libopenbsd-compat.a

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir = @bindir@
libdir = @libdir@

TARGET=ega-qv

OBJS =  src/sshfs/sshfs.o src/sshfs/cache.o src/compat/darwin_compat.o \
	src/readpassphrase.o src/header.o \
	src/c4ghfs.o src/main.o 

.PHONY: $(TARGET)

all: $(TARGET)

$(libdir) $(bindir):
	mkdir -p $@

$(EXTRA_LIBS):
	@echo "Creating dependency $(@:keys/%=%)"
	@make -s -C keys $(@:keys/%=%)

$(TARGET): $(OBJS) $(EXTRA_LIBS)
	@echo "Creating target $@"
	@$(CC) -o $@ $(OBJS) $(LDFLAGS) $(LIBS)

.c.o:
	@echo "Compiling $<"
	@$(CC) $(CPPFLAGS) $(CFLAGS) -c -o $@ $<

clean:
	-rm -f $(OBJS) $(TARGET)
	-@rm -f *~ 

veryclean: clean
	-make -C keys veryclean

distclean: clean
	-rm -f Makefile src/config.h* config.status configure config.log
	-rm -rf autom4te.cache aclocal.m4 src/.depend.old


###################################
## Dependencies
###################################
depend: depend-rebuild
	rm -f src/.depend.bak

depend-rebuild:
	mv src/.depend src/.depend.old
	rm -f src/config.h src/.depend
	touch src/config.h src/.depend
	makedepend -w1000 -I./src -DHAVE_CONFIG_H -Ysrc -f src/.depend src/*.c src/compat/*.c src/sshfs/*.c 2>/dev/null
	(echo '# Automatically generated by makedepend.'; \
	 echo '# Run "make depend" to rebuild.'; sort src/.depend ) >src/.depend.tmp
	mv src/.depend.tmp src/.depend
	rm -f src/.depend.bak
	mv src/.depend.old src/.depend.bak

depend-check: depend-rebuild
	cmp src/.depend src/.depend.bak || (echo src/.depend stale && exit 1)

# @DEPEND@
