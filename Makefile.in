
CC       = @CC@
CPPFLAGS = -I@srcdir@/src @CPPFLAGS@ -fPIC
CFLAGS   = -Wno-unused-result @CFLAGS@ @CPPFLAGS@ @DEFS@ @DEBUG@
LIBS     = @LIBS@
LDFLAGS  = @LDFLAGS@ -L./keys -lc4gh-keys

EXTRA_DEPS = keys/libc4gh-keys.a @EXTRA_DEPS@

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir = @bindir@
libdir = @libdir@

TARGET=ega-qv

OBJS =  src/sshfs/sshfs.o src/sshfs/cache.o src/compat/darwin_compat.o \
	src/readpassphrase.o src/header.o \
	src/c4ghfs.o src/main.o 

.PHONY: $(TARGET)

all: $(TARGET)

$(libdir) $(bindir):
	mkdir -p $@

$(EXTRA_DEPS):
	@echo "Creating dependency $@"
	@make -s -C keys extra_libs

$(TARGET): $(OBJS) $(EXTRA_DEPS)
	@echo "Creating target $@"
	@$(CC) -o $@ $(OBJS) $(LDFLAGS) $(LIBS)

.c.o:
	@echo "Compiling $<"
	@$(CC) $(CPPFLAGS) $(CFLAGS) -c -o $@ $<

install-c4gh-keys: ./keys/libc4gh-keys.so | $(libdir)
	@echo "Installing $< into $(libdir)"
	@install -m 755 $< $(libdir)

install: install-c4gh-keys
install: $(TARGET) | $(bindir)
	@echo "Installing $< into $(bindir)"
	@install -m 755 $< $(bindir)

clean:
	-rm -f $(OBJS) $(TARGET)
	-@rm -f *~ 

veryclean: clean
	-make -C $(KEYS_SRCDIR) veryclean

distclean: clean
	-rm -f Makefile src/config.h* config.status configure config.log
	-rm -rf autom4te.cache aclocal.m4 src/.depend.old


###################################
## Dependencies
###################################
depend: depend-rebuild
	rm -f src/.depend.bak

depend-rebuild:
	mv src/.depend src/.depend.old
	rm -f src/config.h src/.depend
	touch src/config.h src/.depend
	makedepend -w1000 -I./src -DHAVE_CONFIG_H -Ysrc -f src/.depend src/*.c src/compat/*.c src/sshfs/*.c 2>/dev/null
	(echo '# Automatically generated by makedepend.'; \
	 echo '# Run "make depend" to rebuild.'; sort src/.depend ) >src/.depend.tmp
	mv src/.depend.tmp src/.depend
	rm -f src/.depend.bak
	mv src/.depend.old src/.depend.bak

depend-check: depend-rebuild
	cmp src/.depend src/.depend.bak || (echo src/.depend stale && exit 1)

# @DEPEND@
